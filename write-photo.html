---
layout: default
title: Upload Photo
permalink: /write-photo/
---

<div class="write-photo-container" data-page="write-photo">
  <header class="write-photo-header">
    <h2 class="normal-heading">上传一张照片</h2>
    <p class="desc">挑一张值得留下的画面，补上几句说明，就能准备好站点所需的配置。</p>
    <p class="subtle-banner" id="photo-permission-banner" hidden></p>
  </header>

  <section class="photo-section upload-pane" aria-label="选择照片">
    <h3 class="section-title monospace">选择图片</h3>
    <label class="upload-dropzone" for="photo-upload">
      <input type="file" id="photo-upload" accept="image/*" hidden>
      <span class="upload-primary">点击或拖动到这里</span>
      <span class="upload-secondary">支持常见图片格式；上传后会自动生成 ID 和文件名</span>
    </label>
    <div class="image-preview-card" id="image-preview-container" hidden>
      <img id="image-preview" class="image-preview" alt="">
      <div class="image-meta" id="image-info"></div>
    </div>
  </section>

  <section class="photo-section" id="form-section" aria-label="照片信息" hidden>
    <h3 class="section-title monospace">照片信息</h3>
    <form id="photo-form" class="photo-form" novalidate>
      <div class="form-field">
        <div class="field-title">
          <label for="alt-text" class="field-label monospace"><span class="field-required" aria-hidden="true">*</span>Alt 文本</label>
        </div>
        <input type="text" id="alt-text" class="photo-input" placeholder="一句话描述画面内容，方便无障碍阅读" required>
        <span class="field-feedback" id="alt-feedback" aria-live="polite"></span>
      </div>

      <div class="form-field">
        <div class="field-title">
          <label for="caption" class="field-label monospace">图注</label>
        </div>
        <textarea id="caption" class="photo-input" placeholder="想讲的故事、补充信息，Markdown 语法可用"></textarea>
        <span class="field-feedback" id="caption-feedback" aria-live="polite"></span>
      </div>

      <div class="form-field">
        <div class="field-title">
          <label for="location" class="field-label monospace">地点</label>
        </div>
        <input type="text" id="location" class="photo-input" placeholder="在哪儿拍的，可留空">
        <span class="field-feedback" id="location-feedback" aria-live="polite"></span>
      </div>
    </form>
  </section>

  <section class="photo-section" id="preview-section" aria-label="预览" hidden>
    <h3 class="section-title monospace">预览</h3>
    <div class="preview-frame">
      <figure class="figure-landscape" id="preview-figure">
        <a href="#" class="image-link" id="preview-link">
          <img id="preview-photo" alt="" loading="lazy" decoding="async">
        </a>
        <figcaption>
          <div class="desc photo-metadata">
            <div id="preview-date">{{ "now" | date: "%Y/%m/%d (%a)" }}</div>
            <div id="preview-location" hidden></div>
            <open-heart class="text-open-heart" href="#" emoji="❤️">
              <span class="on">已收藏。</span><span class="off">喜欢吗？</span>
            </open-heart>
          </div>
          <div class="caption-container" id="preview-caption-container" hidden>
            <div class="caption-content" id="preview-caption"></div>
          </div>
        </figcaption>
      </figure>
    </div>
  </section>

  <section class="photo-section" id="output-section" aria-label="生成配置" hidden>
    <h3 class="section-title monospace">生成配置与发布</h3>
    <div class="publish-card" id="publish-section">
      <div class="access-field">
        <label for="access-key" class="field-label monospace"><span class="field-required" aria-hidden="true">*</span>访问密钥</label>
        <div class="password-field-wrapper">
          <input type="password" id="access-key" class="photo-input" placeholder="输入约定好的密钥才能发布">
          <button type="button" class="password-toggle" aria-label="显示密码">
            <svg class="eye-icon" viewBox="0 0 24 24" style="display: none;">
              <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
              <circle cx="12" cy="12" r="3"></circle>
            </svg>
            <svg class="eye-slash-icon" viewBox="0 0 24 24" style="display: block;">
              <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
              <line x1="1" y1="1" x2="23" y2="23"></line>
            </svg>
          </button>
        </div>
      </div>
      <div class="publish-actions">
        <button type="button" id="publish-btn" class="publish-button" disabled>
          <span class="btn-text">直接发布</span>
          <span class="btn-loading" hidden>正在提交…</span>
        </button>
        <p class="publish-feedback" id="publish-status" hidden></p>
      </div>
    </div>

    <div class="divider" role="presentation"><span>或</span></div>

    <div class="json-output-card">
      <pre id="json-output" class="json-output"></pre>
      <button type="button" id="copy-json" class="copy-button">复制 JSON</button>
    </div>

    <div class="instructions">
      <h4 class="monospace">手动发布步骤</h4>
      <ol>
        <li>复制上面的 JSON 配置，粘贴到 <code>_data/photos.json</code> 最前面</li>
        <li>把图片重命名为：<code id="suggested-filename">filename.jpg</code></li>
        <li>把图片放到 <code>images/photos/</code> 目录</li>
        <li>提交并推送改动，等部署完成</li>
      </ol>
      <p class="field-hint">提示：访问密钥输入正确时，可以跳过这些步骤由脚本直接处理。</p>
    </div>
  </section>
</div>

<script>
(function() {
  'use strict';

  const fileInput = document.getElementById('photo-upload');
  const imagePreviewContainer = document.getElementById('image-preview-container');
  const imagePreview = document.getElementById('image-preview');
  const imageInfo = document.getElementById('image-info');
  const formSection = document.getElementById('form-section');
  const previewSection = document.getElementById('preview-section');
  const outputSection = document.getElementById('output-section');
  const permissionBanner = document.getElementById('photo-permission-banner');

  const altTextInput = document.getElementById('alt-text');
  const captionInput = document.getElementById('caption');
  const locationInput = document.getElementById('location');

  const previewPhoto = document.getElementById('preview-photo');
  const previewFigure = document.getElementById('preview-figure');
  const previewDate = document.getElementById('preview-date');
  const previewLocation = document.getElementById('preview-location');
  const previewCaptionContainer = document.getElementById('preview-caption-container');
  const previewCaption = document.getElementById('preview-caption');

  const jsonOutput = document.getElementById('json-output');
  const copyButton = document.getElementById('copy-json');
  const suggestedFilename = document.getElementById('suggested-filename');

  const accessKeyInput = document.getElementById('access-key');
  const publishBtn = document.getElementById('publish-btn');
  const publishStatus = document.getElementById('publish-status');

  let photoData = null;
  let selectedFile = null;

  init();

  function init() {
    checkUserPermission();
    attachEvents();
    restoreAccessKey();
  }

  function checkUserPermission() {
    const isOwnerActivated = localStorage.getItem('show-write-entry') === 'true';
    const directAccess = !document.referrer || !document.referrer.includes(window.location.origin);

    if (!isOwnerActivated && directAccess) {
      permissionBanner.hidden = false;
      permissionBanner.textContent = '这个入口通常只对站长开放，随便看看也无妨，真正发布需要密钥。';
    }
  }

  function attachEvents() {
    fileInput.addEventListener('change', handleFileSelect);
    [altTextInput, captionInput, locationInput].forEach(input => {
      input.addEventListener('input', () => {
        updatePreview();
        updatePublishState();
      });
    });

    accessKeyInput.addEventListener('input', updatePublishState);

    publishBtn.addEventListener('click', async () => {
      if (!selectedFile || !photoData?.meta.alt) {
        showPublishStatus('图片或 Alt 文本还没准备好。', 'error');
        return;
      }

      const accessKey = accessKeyInput.value.trim();
      if (!accessKey) {
        showPublishStatus('请输入访问密钥再尝试发布。', 'error');
        return;
      }

      await publishPhoto(accessKey);
    });

    copyButton.addEventListener('click', handleCopyJson);
  }

  function restoreAccessKey() {
    const saved = localStorage.getItem('photo-access-key');
    if (!saved) return;

    try {
      accessKeyInput.value = atob(saved);
    } catch (error) {
      localStorage.removeItem('photo-access-key');
    }
  }

  function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;

    selectedFile = file;
    readFileMetadata(file);
  }

  async function readFileMetadata(file) {
    try {
      const uuid = generateUUID();
      const timestamp = new Date().toISOString();
      const imageData = await getImageRatio(file);
      const filename = deriveFilename(file, uuid);

      photoData = {
        id: uuid,
        uploaded: timestamp,
        variants: [`/images/photos/${filename}`],
        meta: {
          ratio: imageData.ratio,
          alt: '',
          caption: undefined,
          location: undefined
        },
        filename,
        originalName: file.name || filename,
        originalSize: file.size,
        dimensions: {
          width: imageData.width,
          height: imageData.height
        }
      };

      renderPreviewCard(file, imageData, uuid, filename);
      suggestedFilename.textContent = filename;
      updatePreview();
      toggleSections(true);
    } catch (error) {
      console.error('无法读取图片信息:', error);
      showPublishStatus('读取图片信息时出错，请换一张试试。', 'error');
    }
  }

  function renderPreviewCard(file, imageData, uuid, filename) {
    const reader = new FileReader();
    reader.onload = event => {
      imagePreview.src = event.target.result;
      imagePreview.alt = file.name;

      imageInfo.innerHTML = `
        <div><span>原文件</span><span>${photoData.originalName}</span></div>
        <div><span>体积</span><span>${formatFileSize(file.size)}</span></div>
        <div><span>尺寸</span><span>${imageData.width} × ${imageData.height}</span></div>
        <div><span>比例</span><span>${imageData.ratio}</span></div>
        <div><span>UUID</span><span>${uuid}</span></div>
        <div><span>建议文件名</span><span>${filename}</span></div>
      `;

      imagePreviewContainer.hidden = false;
    };
    reader.readAsDataURL(file);
  }

  async function publishPhoto(accessKey) {
    try {
      setPublishLoading(true);
      showPublishStatus('正在准备上传…', 'info');

      const uploadData = await buildUploadPayload();
      const response = await fetch('/api/upload-photo', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Access-Key': accessKey
        },
        body: JSON.stringify(uploadData)
      });

      if (!response.ok) {
        const text = await response.text();
        throw new Error(text || `HTTP ${response.status}`);
      }

      const result = await response.json();
      if (result?.success) {
        localStorage.setItem('photo-access-key', btoa(accessKey));
        showPublishStatus('发布成功！正在跳转到首页...', 'success');

        setTimeout(() => {
          window.location.href = '/';
        }, 1500);
      } else {
        throw new Error(result?.error || '服务端没有返回成功标记');
      }
    } catch (error) {
      console.error('上传失败:', error);
      showPublishStatus(`上传失败：${error.message}`, 'error');
    } finally {
      setPublishLoading(false);
    }
  }

  async function buildUploadPayload() {
    const base64Data = await toBase64(selectedFile);

    const basePayload = {
      imageData: base64Data,
      filename: photoData.filename,
      photoData: {
        id: photoData.id,
        uploaded: photoData.uploaded,
        variants: photoData.variants,
        meta: {
          ratio: photoData.meta.ratio,
          alt: photoData.meta.alt
        }
      }
    };

    if (photoData.meta.caption) {
      basePayload.photoData.meta.caption = photoData.meta.caption;
    }

    if (photoData.meta.location) {
      basePayload.photoData.meta.location = photoData.meta.location;
    }

    return basePayload;
  }

  function setPublishLoading(state) {
    publishBtn.disabled = state || !canPublish();
    publishBtn.querySelector('.btn-text').hidden = state;
    publishBtn.querySelector('.btn-loading').hidden = !state;
  }

  function showPublishStatus(message, tone) {
    publishStatus.textContent = message;
    publishStatus.dataset.tone = tone;
    publishStatus.hidden = false;

    if (tone === 'success') {
      setTimeout(() => {
        publishStatus.hidden = true;
      }, 6000);
    }
  }

  function handleCopyJson() {
    navigator.clipboard.writeText(jsonOutput.textContent).then(() => {
      const original = copyButton.textContent;
      copyButton.textContent = '已复制';
      copyButton.classList.add('copied');
      setTimeout(() => {
        copyButton.textContent = original;
        copyButton.classList.remove('copied');
      }, 1800);
    });
  }

  function updatePreview() {
    if (!photoData || !selectedFile) return;

    photoData.meta.alt = altTextInput.value.trim();
    photoData.meta.caption = captionInput.value.trim() || undefined;
    photoData.meta.location = locationInput.value.trim() || undefined;

    previewPhoto.src = imagePreview.src;
    previewPhoto.alt = photoData.meta.alt;
    previewFigure.className = photoData.meta.ratio > 1 ? 'figure-landscape' : 'figure-portrait';

    const now = new Date();
    const weekdays = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
    previewDate.textContent = `${now.getFullYear()}/${String(now.getMonth() + 1).padStart(2, '0')}/${String(now.getDate()).padStart(2, '0')} (${weekdays[now.getDay()]})`;

    if (photoData.meta.location) {
      previewLocation.textContent = `@ ${photoData.meta.location}`;
      previewLocation.hidden = false;
    } else {
      previewLocation.hidden = true;
    }

    if (photoData.meta.caption) {
      previewCaption.textContent = photoData.meta.caption;
      previewCaptionContainer.hidden = false;
    } else {
      previewCaptionContainer.hidden = true;
    }

    renderOutputJson();
    togglePreviewOutputs();
  }

  function renderOutputJson() {
    if (!photoData) return;

    const output = {
      id: photoData.id,
      uploaded: photoData.uploaded,
      variants: photoData.variants,
      meta: {
        ratio: photoData.meta.ratio,
        alt: photoData.meta.alt
      }
    };

    if (photoData.meta.caption) output.meta.caption = photoData.meta.caption;
    if (photoData.meta.location) output.meta.location = photoData.meta.location;

    jsonOutput.textContent = JSON.stringify(output, null, 2);
  }

  function toggleSections(hasData) {
    formSection.hidden = !hasData;
    if (!hasData) {
      previewSection.hidden = true;
      outputSection.hidden = true;
    }
  }

  function togglePreviewOutputs() {
    const ready = Boolean(photoData?.meta.alt && photoData.meta.alt.length > 0);
    previewSection.hidden = !ready;
    outputSection.hidden = !ready;
  }

  function updatePublishState() {
    publishBtn.disabled = !canPublish();
  }

  function canPublish() {
    return Boolean(selectedFile && photoData?.meta.alt && accessKeyInput.value.trim().length > 0);
  }

  function toBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = event => resolve(event.target.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  function generateUUID() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, char => {
      const random = Math.random() * 16 | 0;
      const value = char === 'x' ? random : (random & 0x3 | 0x8);
      return value.toString(16);
    });
  }

  function getImageRatio(file) {
    return new Promise(resolve => {
      const img = new Image();
      img.onload = () => {
        const ratio = img.width / img.height;
        resolve({
          ratio: Number(ratio.toFixed(2)),
          width: img.width,
          height: img.height
        });
      };
      img.src = URL.createObjectURL(file);
    });
  }

  function formatFileSize(bytes) {
    if (!bytes) return '0 B';
    const base = 1024;
    const units = ['B', 'KB', 'MB', 'GB'];
    const exponent = Math.min(Math.floor(Math.log(bytes) / Math.log(base)), units.length - 1);
    const size = bytes / Math.pow(base, exponent);
    return `${size.toFixed(exponent === 0 ? 0 : 2)} ${units[exponent]}`;
  }

  function deriveFilename(file, fallbackId) {
    const originalName = (file.name || '').trim();
    let base = '';
    let ext = '';

    if (originalName) {
      const lastDot = originalName.lastIndexOf('.');
      if (lastDot > 0) {
        base = originalName.slice(0, lastDot);
        ext = originalName.slice(lastDot + 1);
      } else {
        base = originalName;
      }
    }

    base = sanitizeSegment(base);
    ext = sanitizeSegment(ext).replace(/\.+/g, '').toLowerCase();

    if (!ext) {
      const mimeExt = (file.type && file.type.includes('/')) ? file.type.split('/').pop() : '';
      ext = sanitizeSegment(mimeExt).replace(/\.+/g, '').toLowerCase();
    }

    if (!ext) ext = 'jpg';
    if (!base) base = fallbackId;

    return `${base}.${ext}`;
  }

  function sanitizeSegment(segment) {
    if (!segment) return '';
    let result = segment.normalize ? segment.normalize('NFKD') : segment;
    result = result.replace(/[\u0300-\u036f]/g, '');
    result = result.replace(/[^a-zA-Z0-9._-]+/g, '-');
    result = result.replace(/-+/g, '-');
    result = result.replace(/^-|-$/g, '');
    return result.toLowerCase();
  }
})();
</script>
