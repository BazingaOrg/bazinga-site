---
layout: default
title: Write Note
permalink: /write-note/
---

<div class="write-note-container" data-page="write-note">
  <header class="write-note-header">
    <h2 class="normal-heading">随手记一条</h2>
    <p class="desc">写点眼前的碎念、保留一丝当下的气味。</p>
    <p class="subtle-banner" id="permission-banner" hidden></p>
  </header>

  <div class="write-note-body">
    <section class="preview-section" aria-live="polite" aria-label="随笔预览">
      <h3 class="section-title monospace">预览</h3>
      <div class="preview-card">
        <article class="note" id="preview-note">
          <time class="general-actions monospace" id="preview-time" datetime="{{ "now" | date_to_xmlschema }}">
            {{ "now" | date: "%Y/%m/%d" }}
          </time>
          <div class="note-content" lang="zh-CN" id="preview-content">
            <p class="placeholder-text">文字会在这里出现，像刚写完一样新鲜。</p>
          </div>
          <div class="note-tags" id="preview-tags"></div>
        </article>
      </div>
    </section>

    <section class="form-section" aria-label="随笔设置">
      <form id="note-form" class="note-form" novalidate>
        <input type="hidden" id="title" name="title">

        <div class="form-field">
          <div class="field-title">
            <label for="content" class="field-label monospace"><span class="field-required" aria-hidden="true">*</span>正文</label>
          </div>
          <textarea
            id="content"
            name="content"
            placeholder="想写什么就写什么，空一行可以分段，Markdown 也支持"
            required
          ></textarea>
          <span class="field-feedback" id="content-feedback" role="status" aria-live="polite"></span>
        </div>

        <fieldset class="form-field tag-field">
            <legend class="field-title">
            <span class="field-label monospace"><span class="field-required" aria-hidden="true">*</span>标签</span>
          </legend>
          <div class="tag-pool" id="existing-tags">
            {% assign notes = site.notes | sort: "date" | reverse %}
            {% assign tag_list_string = '' %}
            {% for note in notes %}
              {% for tag in note.tags %}
                {% unless tag == '' %}
                  {% assign tag_list_string = tag_list_string | append: tag | append: ',' %}
                {% endunless %}
              {% endfor %}
            {% endfor %}
            {% assign tag_list = tag_list_string | split: ',' %}
            {% assign unique_tags = tag_list | uniq %}
            {% assign tag_counts = '' %}
            {% for tag in unique_tags %}
              {% unless tag == '' %}
                {% assign occurrences = 0 %}
                {% for t in tag_list %}
                  {% if t == tag %}
                    {% assign occurrences = occurrences | plus: 1 %}
                  {% endif %}
                {% endfor %}
                {% assign padded = '0000' | append: occurrences %}
                {% assign padded = padded | slice: -4, 4 %}
                {% assign tag_counts = tag_counts | append: padded | append: '|' | append: tag | append: ',' %}
              {% endunless %}
            {% endfor %}
            {% assign tag_pairs = tag_counts | split: ',' | sort | reverse %}
            {% assign displayed_pairs = tag_pairs | slice: 0, 4 %}
            {% assign displayed_count = 0 %}
            {% for pair in displayed_pairs %}
              {% if pair != '' %}
                {% assign parts = pair | split: '|' %}
                {% assign tag_name = parts[1] %}
                {% if tag_name and tag_name != '' %}
                  {% assign displayed_count = displayed_count | plus: 1 %}
                  <label class="tag-chip">
                    <input type="checkbox" value="{{ tag_name }}" class="tag-checkbox" data-tag="{{ tag_name }}">
                    <span class="tag-name">{{ tag_name }}</span>
                  </label>
                {% endif %}
              {% endif %}
            {% endfor %}
            {% if displayed_count == 0 %}
              <p class="field-hint">目前没有历史标签，先写一篇随笔试试吧。</p>
            {% endif %}
          </div>
          <div class="custom-tags">
            <label for="custom-tags" class="field-hint monospace">自定义标签</label>
            <input
              type="text"
              id="custom-tags"
              name="custom-tags"
              placeholder="新的标签，用逗号隔开，例如：夜读，随记"
              class="monospace"
            >
            <p class="field-hint">按逗号自动拆分，无需刻意控制空格。</p>
          </div>
          <span class="field-feedback" id="tags-feedback" role="status" aria-live="polite"></span>
        </fieldset>

        <div class="form-field">
          <div class="field-title">
            <label for="access-key" class="field-label monospace"><span class="field-required" aria-hidden="true">*</span>访问密钥</label>
          </div>
          <div class="password-field-wrapper">
            <input
              type="password"
              id="access-key"
              name="access-key"
              placeholder="输入约定好的密钥才能发布"
              autocomplete="current-password"
              required
            >
            <button type="button" class="password-toggle" aria-label="显示密码">
              <svg class="eye-icon" viewBox="0 0 24 24" style="display: none;">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                <circle cx="12" cy="12" r="3"></circle>
              </svg>
              <svg class="eye-slash-icon" viewBox="0 0 24 24" style="display: block;">
                <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                <line x1="1" y1="1" x2="23" y2="23"></line>
              </svg>
            </button>
          </div>
          <span class="field-feedback" id="access-key-feedback" role="status" aria-live="polite"></span>
        </div>

        <div class="form-actions">
          <button type="submit" class="submit-btn" id="submit-btn">
            <span class="btn-text">发布随笔</span>
            <span class="btn-loading">正在发布…</span>
          </button>
          <button type="button" class="ghost-button" id="reset-draft-btn">清空草稿</button>
        </div>
      </form>

      <div class="status-message" id="status-message" role="status" aria-live="polite"></div>
    </section>
  </div>
</div>

<script>
(function() {
  'use strict';

  const NOTE_ID_PATTERN = /^\d{12}$/;
  const NOTE_TIME_ZONE = 'Asia/Shanghai';
  const MAX_TAGS = 3;
  const NOTE_IDENTIFIER_FORMATTER = new Intl.DateTimeFormat('en-CA', {
    timeZone: NOTE_TIME_ZONE,
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    hour12: false
  });
  const NOTE_PREVIEW_FORMATTER = new Intl.DateTimeFormat('zh-CN', {
    timeZone: NOTE_TIME_ZONE,
    year: 'numeric',
    month: '2-digit',
    day: '2-digit'
  });

  const form = document.getElementById('note-form');
  const titleInput = document.getElementById('title');
  const contentInput = document.getElementById('content');
  const customTagsInput = document.getElementById('custom-tags');
  const accessKeyInput = document.getElementById('access-key');
  const submitBtn = document.getElementById('submit-btn');
  const resetDraftBtn = document.getElementById('reset-draft-btn');
  const statusMessage = document.getElementById('status-message');
  const permissionBanner = document.getElementById('permission-banner');

  const previewContent = document.getElementById('preview-content');
  const previewTags = document.getElementById('preview-tags');
  const previewTime = document.getElementById('preview-time');

  let isSubmitting = false;
  let hasUserInteracted = false;

  const FEEDBACK = {
    content: document.getElementById('content-feedback'),
    tags: document.getElementById('tags-feedback'),
    accessKey: document.getElementById('access-key-feedback')
  };

  init();

  function init() {
    ensureGeneratedTitle({ force: true });
    checkUserPermission();
    updatePreviewTime();

    contentInput.addEventListener('input', () => {
      hasUserInteracted = true;
      updatePreview();
    });

    customTagsInput.addEventListener('input', () => {
      hasUserInteracted = true;
      updatePreview();
    });

    accessKeyInput.addEventListener('input', () => {
      hasUserInteracted = true;
      clearFeedback('accessKey');
    });

    document.querySelectorAll('.tag-checkbox').forEach(checkbox => {
      checkbox.addEventListener('change', () => {
        handleTagCheckboxChange(checkbox);
      });
    });

    form.addEventListener('submit', handleSubmit);

    resetDraftBtn.addEventListener('click', () => {
      form.reset();
      document.querySelectorAll('.tag-checkbox:checked').forEach(cb => cb.checked = false);
      localStorage.removeItem('note-draft');
      updatePreview();
      showStatus('草稿已清空。', 'info');
    });

    const savedKey = localStorage.getItem('note-access-key');
    if (savedKey) {
      try {
        accessKeyInput.value = atob(savedKey);
      } catch (error) {
        localStorage.removeItem('note-access-key');
      }
    }

    updatePreview();

    setInterval(saveDraft, 30000);
    loadDraft();
  }

  function checkUserPermission() {
    const isOwnerActivated = localStorage.getItem('show-write-entry') === 'true';
    const directAccess = !document.referrer || !document.referrer.includes(window.location.origin);

    if (!isOwnerActivated && directAccess) {
      permissionBanner.hidden = false;
      permissionBanner.textContent = '这个入口通常只对站长开放，既然你发现了，就随便看看预览，不必真的提交。';
    }
  }

  function updatePreviewTime() {
    const identifiers = generateNoteIdentifiers();
    previewTime.textContent = identifiers.dateDisplay;
    previewTime.setAttribute('datetime', identifiers.isoLocal);
  }

  function generateNoteIdentifiers(baseDate = new Date()) {
    const parts = {};

    NOTE_IDENTIFIER_FORMATTER.formatToParts(baseDate).forEach(({ type, value }) => {
      if (type !== 'literal') {
        parts[type] = value;
      }
    });

    const year = parts.year || '0000';
    const month = parts.month || '00';
    const day = parts.day || '00';
    const hour = parts.hour || '00';
    const minute = parts.minute || '00';

    const filename = `note-${year}-${month}-${day}-${hour}${minute}`;

    return {
      title: `${year}${month}${day}${hour}${minute}`,
      filename,
      isoLocal: `${year}-${month}-${day}T${hour}:${minute}:00+08:00`,
      dateDisplay: NOTE_PREVIEW_FORMATTER.format(baseDate)
    };
  }

  function ensureGeneratedTitle({ force } = {}) {
    const currentValue = titleInput.value.trim();

    if (!force && NOTE_ID_PATTERN.test(currentValue)) {
      return currentValue;
    }

    const { title } = generateNoteIdentifiers();
    titleInput.value = title;
    return title;
  }

  function updatePreview() {
    updatePreviewTime();
    const rawContent = contentInput.value.trim();

    if (rawContent) {
      const htmlContent = rawContent
        .replace(/\n\n/g, '</p><p>')
        .replace(/\n/g, '<br>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/`(.*?)`/g, '<code>$1</code>');

      previewContent.innerHTML = '<p>' + htmlContent + '</p>';
      previewContent.classList.remove('placeholder');
    } else {
      previewContent.innerHTML = '<p class="placeholder-text">文字会在这里出现，像刚写完一样新鲜。</p>';
      previewContent.classList.add('placeholder');
    }

    renderTags();

    if (hasUserInteracted) {
      validateForm();
    }
  }

  function renderTags() {
    const { tags: selectedTags, overflowed } = getSelectedTags();
    previewTags.innerHTML = '';

    selectedTags.forEach(tag => {
      const tagSpan = document.createElement('span');
      tagSpan.className = 'note-tag';
      tagSpan.dataset.tag = tag;
      tagSpan.textContent = tag;
      previewTags.appendChild(tagSpan);
    });

    if (!overflowed && selectedTags.length) {
      clearFeedback('tags');
    }
  }

  function handleTagCheckboxChange(checkbox) {
    hasUserInteracted = true;

    if (checkbox.checked) {
      const checkedCount = document.querySelectorAll('.tag-checkbox:checked').length;
      if (checkedCount > MAX_TAGS) {
        checkbox.checked = false;
        showFeedback('tags', `标签最多选择 ${MAX_TAGS} 个。`);
        validateForm();
        return;
      }
    }

    updatePreview();
  }

  function getSelectedTags(options = {}) {
    const { report = false } = options;
    const tags = [];
    let overflowed = false;

    document.querySelectorAll('.tag-checkbox:checked').forEach(cb => {
      const tagValue = cb.value.trim();
      if (!tagValue) return;

      if (tags.includes(tagValue)) {
        return;
      }

      if (tags.length < MAX_TAGS) {
        tags.push(tagValue);
      } else {
        overflowed = true;
        cb.checked = false;
      }
    });

    const customTags = customTagsInput.value.trim();
    if (customTags) {
      customTags.split(',')
        .map(tag => tag.trim())
        .filter(tag => tag.length)
        .forEach(tag => {
          if (tags.includes(tag)) {
            return;
          }

          if (tags.length < MAX_TAGS) {
            tags.push(tag);
          } else {
            overflowed = true;
          }
        });
    }

    if (report && overflowed) {
      showFeedback('tags', `标签最多选择 ${MAX_TAGS} 个，请删掉多余的。`);
    }

    return { tags, overflowed };
  }

  function validateForm() {
    let isValid = true;

    const title = ensureGeneratedTitle();
    if (!NOTE_ID_PATTERN.test(title)) {
      showStatus('标题生成出现异常，请刷新页面后再试。', 'error');
      isValid = false;
    }

    const content = contentInput.value.trim();
    if (!content) {
      showFeedback('content', '正文还是空的，随便写两句试试。');
      isValid = false;
    } else if (content.length < 16) {
      showFeedback('content', '再多写一点点，未来的你会感激现在的你。', 'soft');
    } else {
      clearFeedback('content');
    }

    const { tags, overflowed } = getSelectedTags({ report: true });
    if (tags.length === 0) {
      showFeedback('tags', '选一个标签方便以后回看。');
      isValid = false;
    } else if (!overflowed) {
      clearFeedback('tags');
    }

    if (overflowed) {
      isValid = false;
    }

    const accessKey = accessKeyInput.value.trim();
    if (!accessKey) {
      showFeedback('accessKey', '密钥缺席，系统会礼貌地拒绝。');
      isValid = false;
    } else {
      clearFeedback('accessKey');
    }

    return isValid;
  }

  function showFeedback(field, message, tone = 'error') {
    const slot = FEEDBACK[field];
    if (!slot) return;

    slot.textContent = message;
    slot.dataset.tone = tone;
  }

  function clearFeedback(field) {
    const slot = FEEDBACK[field];
    if (!slot) return;

    slot.textContent = '';
    slot.removeAttribute('data-tone');
  }

  async function handleSubmit(event) {
    event.preventDefault();

    if (isSubmitting) return;
    if (!validateForm()) return;

    const identifiers = generateNoteIdentifiers();
    titleInput.value = identifiers.title;

    const { tags } = getSelectedTags({ report: true });

    const formData = {
      title: identifiers.title,
      content: contentInput.value.trim(),
      tags,
      lang: 'zh-CN',
      filenameHint: identifiers.filename
    };

    const accessKey = accessKeyInput.value.trim();

    try {
      setSubmitting(true);

      const response = await fetch('/api/create-note', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Access-Key': accessKey
        },
        body: JSON.stringify(formData)
      });

      const result = await response.json();

      if (response.ok) {
        // 自动删除草稿
        localStorage.removeItem('note-draft');
        localStorage.setItem('note-access-key', btoa(accessKey));

        // 显示成功消息并跳转到首页
        showStatus(`发布成功！正在跳转到首页...`, 'success');

        setTimeout(() => {
          window.location.href = '/';
        }, 1500);
      } else {
        showStatus(result.error || '发布没有成功，稍后再试一次吧。', 'error');
      }
    } catch (error) {
      console.error('Submission error:', error);
      showStatus('网络好像断了，刷新或稍等一会儿再试。', 'error');
    } finally {
      setSubmitting(false);
    }
  }

  function setSubmitting(state) {
    isSubmitting = state;
    submitBtn.classList.toggle('loading', state);
    submitBtn.disabled = state;
  }

  function showStatus(message, type) {
    statusMessage.innerHTML = message;
    statusMessage.dataset.type = type;
    statusMessage.style.display = 'block';

    if (type === 'success' || type === 'info') {
      setTimeout(() => {
        statusMessage.style.display = 'none';
      }, 10000);
    }
  }

  function saveDraft() {
    const draft = {
      content: contentInput.value,
      customTags: customTagsInput.value,
      selectedTags: Array.from(document.querySelectorAll('.tag-checkbox:checked')).map(cb => cb.value)
    };

    if (draft.content.trim() || draft.customTags.trim() || draft.selectedTags.length) {
      localStorage.setItem('note-draft', JSON.stringify(draft));
    } else {
      localStorage.removeItem('note-draft');
    }
  }

  function loadDraft() {
    const rawDraft = localStorage.getItem('note-draft');
    if (!rawDraft) return;

    try {
      const draft = JSON.parse(rawDraft);
      contentInput.value = draft.content || '';
      customTagsInput.value = draft.customTags || '';

      if (draft.selectedTags) {
        draft.selectedTags.forEach(tagValue => {
          const checkbox = document.querySelector(`.tag-checkbox[value="${tagValue}"]`);
          if (checkbox) {
            checkbox.checked = true;
          }
        });
      }

      updatePreview();
    } catch (error) {
      console.warn('无法加载草稿:', error);
    }
  }
})();
</script>
